# Tsumugi Spark

![](static/tsumugi-spark-logo.png)

**_NOTE:_** _Tsumugi Shiraui is a chimera: a hybrid of Human and Gauna. She combines the chaotic power of Gauna with a Human intillegence and empathia. Like an original character of the Manga "Knights of Sidonia", this project aims to make a hybrid of very powerful but hard to learn and use Deequ Scala Library with a usability and simplicity of Spark Connect (PySpark Connect, Spark Connect Go, Spark Connect Rust, etc.)._

## About

The goal of the project is to create a modern, SparkConnect native wrapper on top of a beautiful and very fast Data Quality library [AWS Deequ](https://github.com/awslabs/deequ).

## Why another wrapper?

While Amazon Deequ itself is very well maintained, the existing PyDeequ wrapper has two main problems:

1. It is made via direct `py4j` calls to underlying Deequ Scala library. The first problem here is that it cannot be used in any SparkConnect environment. The bigger problem is that `py4j` is not so well suited for working with Scala code: just try to create `Option[Long]` from Python with `py4j` to understand what I'm talking about;
2. It is suffering from the lack of maintenance (I think that the strong reason of it is the p.1). Just check [this issue](https://github.com/awslabs/python-deequ/issues/192).

## Goals of the project

- Maintain `proto3` definitions of basic Deequ Scala structures (like Check, Analyzer, AnoalyDetectionStrategy, VerificationSuite, Constraint, etc.);
- Maintain Scala SparkConnect Plugin that allows working with Deequ fro any client;
- (Low Priority) Maintain Python client that provides a user-friendly API on top of generated by `protoc` classes

## Non-goals of the project

- Creating just another low-code / zero-code Data Quality tool: Deequ Scala is a very cool, Apache Spark Native, Data Quality engine that allows to compute a lot of things on scale. Anyone can create own `yaml` / `json` parametrization, dahsboards, or any other drag-n-drop low-code solution using Deequ.

## Project structure

### Protobuf messages

`tsumugi-server/src/main/protobuf/` contains messages that define the main structures of Deequ Scala library:

- `VerificationSuite` as a top-level Deequ object. See `suite.proto` for details;
- `Analyzer` object that is defined using `oneof` from list of analyzers (`CountDistinct`, `Size`, `Compliance`, etc.). See `analyzers.proto` for details of the implementation;
- `AnaomalyDetection` and strategies of anomaly detection. See `strategies.proto` for details;
- `Check` that is defined using `Constraint`, `CheckLevel` and description;
- `Constraint` itself that is defined as an Analyzer (that computes a metric), a reference value and a comparison sign;

### SparkConnect Plugin

`tsumugi-server/src/main/scala/org/apache/spark/sql/DeequConnectPlugin.scala` contains the plugin itself code. It is made very simple, about 50 lines of code. It just checks if the message is `VerificationSuite`, passes it into `DeequSuiteBuilder` and after that packs it back to `Relation`.

### Deequ Suite Builder

`tsumugi-server/src/main/scala/com/ssinchenko/DeequSuiteBuilder.scala` contains a code, that creates Deequ objects from protobuf messages. It maps enums and constants into enums and constants of Deequ, creates `com.amazon.deequ` objects from the corresponding protobuf messages. Returns a ready to use Deequ top-level structure.


